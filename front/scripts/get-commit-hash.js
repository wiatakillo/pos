#!/usr/bin/env node
const { execSync } = require('child_process');
const fs = require('fs');
const path = require('path');

// Ensure the output directory exists
const outputDir = path.join(__dirname, '../src/environments');
const outputPath = path.join(outputDir, 'commit-hash.ts');

// Create directory if it doesn't exist
if (!fs.existsSync(outputDir)) {
  fs.mkdirSync(outputDir, { recursive: true });
}

let commitHash = 'git hash';

// First, try to use COMMIT_HASH environment variable (passed as build arg)
if (process.env.COMMIT_HASH && process.env.COMMIT_HASH.trim() !== '') {
  commitHash = process.env.COMMIT_HASH.trim();
  console.log(`✓ Using commit hash from build argument: ${commitHash}`);
} else {
  try {
    // Get the short commit hash (7 characters)
    // Use cwd to ensure we're in the right directory (works in Docker)
    const gitCommand = 'git rev-parse --short HEAD';
    commitHash = execSync(gitCommand, { 
      encoding: 'utf-8',
      cwd: path.join(__dirname, '..'),
      stdio: ['ignore', 'pipe', 'ignore']
    }).trim();
    
    if (!commitHash || commitHash.length === 0) {
      throw new Error('Empty commit hash');
    }
    
    console.log(`✓ Commit hash generated from git: ${commitHash}`);
  } catch (error) {
    // Fallback if git is not available or not in a git repo
    console.log('⚠ Could not get commit hash from git, using "git hash"');
    if (error.message) {
      console.log(`  Reason: ${error.message}`);
    }
  }
}

// Always write the file (ensures it exists even if git fails)
const content = `// This file is auto-generated during build
// Do not edit this file manually
export const commitHash = '${commitHash}';
`;

try {
  fs.writeFileSync(outputPath, content, 'utf-8');
  console.log(`✓ Commit hash file written successfully: ${outputPath}`);
} catch (writeError) {
  console.error(`✗ Error writing commit hash file: ${writeError.message}`);
  // Don't fail the build - the file with 'git hash' should already exist
  process.exit(0); // Exit successfully to not break the build
}
