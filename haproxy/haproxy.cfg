global
    log stdout format raw local0
    maxconn 4096
    daemon

defaults
    log global
    mode http
    option httplog
    option dontlognull
    timeout connect 5000ms
    timeout client 50000ms
    timeout server 50000ms
    option forwardfor

# Frontend - listen on port 4202
frontend http_frontend
    bind *:4202
    mode http
    
    # WebSocket connections - detect Upgrade header OR path starting with /ws
    acl is_websocket hdr(Upgrade) -i websocket
    acl is_websocket_path path_beg /ws
    use_backend ws_backend if is_websocket OR is_websocket_path
    
    # API requests - route to backend
    acl is_api path_beg /api
    use_backend api_backend if is_api
    
    # Everything else - route to frontend
    default_backend frontend_backend

# Backend for WebSocket connections
backend ws_backend
    mode http
    balance roundrobin
    option httpchk GET /health
    http-check expect status 200
    # Remove /ws prefix from path (e.g., /ws/tenant/1 -> /tenant/1, /ws/table/token -> /table/token)
    # Note: regsub pattern matches /ws/ at start and replaces with /
    http-request set-path %[path,regsub(^/ws/,/)]
    server ws1 ws-bridge:8021 check

# Backend for API requests
backend api_backend
    mode http
    balance roundrobin
    option httpchk GET /docs
    http-check expect status 200
    # Remove /api prefix from path
    http-request set-path %[path,regsub(^/api/,/)]
    server api1 back:8020 check

# Backend for frontend static files
backend frontend_backend
    mode http
    balance roundrobin
    server front1 front:4200 check
